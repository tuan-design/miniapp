<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B·∫£ng ƒëi·ªÅu khi·ªÉn T√†i ch√≠nh</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;700&display=swap');
    body {
      font-family: 'Be Vietnam Pro', sans-serif;
      background-color: #f4f7f6;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: none; /* ·∫®n ƒëi cho ƒë·∫øn khi d·ªØ li·ªáu ƒë∆∞·ª£c t·∫£i xong */
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    .summary-cards {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
    }
    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 20px;
      text-align: center;
      flex-grow: 1;
      min-width: 250px;
    }
    .card h2 {
      margin-top: 0;
      font-size: 16px;
      color: #7f8c8d;
    }
    .card .amount {
      font-size: 28px;
      font-weight: 700;
    }
    .income { color: #27ae60; }
    .expense { color: #c0392b; }
    .balance { color: #2980b9; }
    
    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
    }
    .chart-container {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .transactions-container {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f8f9fa;
      font-weight: 700;
    }
    
    .loader {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 2s linear infinite;
      margin: 50px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
        text-align: center;
        color: #c0392b;
        font-size: 18px;
    }
  </style>
</head>
<body>
  
  <h1>B·∫£ng ƒëi·ªÅu khi·ªÉn T√†i ch√≠nh - Th√°ng <span id="month-display"></span></h1>
  
  <div id="loader" class="loader"></div>
  <div id="error-message" class="error"></div>
  
  <div id="main-container" class="container">
    <div class="summary-cards">
      <div class="card">
        <h2>üí∞ T·ªïng Thu nh·∫≠p</h2>
        <p id="total-income" class="amount income">0 VNƒê</p>
      </div>
      <div class="card">
        <h2>üí∏ T·ªïng Chi ti√™u</h2>
        <p id="total-expense" class="amount expense">0 VNƒê</p>
      </div>
      <div class="card">
        <h2>üíπ S·ªë d∆∞</h2>
        <p id="balance" class="amount balance">0 VNƒê</p>
      </div>
    </div>
    
    <div class="chart-grid">
        <div class="chart-container">
          <h3>Ph√¢n lo·∫°i Chi ti√™u</h3>
          <canvas id="category-chart"></canvas>
        </div>
        <div class="chart-container">
          <h3>D√≤ng ti·ªÅn trong Th√°ng</h3>
          <canvas id="trend-chart"></canvas>
        </div>
    </div>
    
    <div class="transactions-container">
      <h3>Giao d·ªãch G·∫ßn nh·∫•t</h3>
      <table>
        <thead>
          <tr>
            <th>Ng√†y</th>
            <th>M√¥ t·∫£</th>
            <th>S·ªë ti·ªÅn</th>
          </tr>
        </thead>
        <tbody id="recent-transactions-body">
          </tbody>
      </table>
    </div>
  </div>

  <script>
    // L·∫•y tham s·ªë th√°ng t·ª´ bi·∫øn ƒë∆∞·ª£c truy·ªÅn v√†o b·ªüi doGet
    const currentMonth = <?= month ?>;
    document.getElementById('month-display').textContent = currentMonth;

    // Ch·∫°y khi trang ƒë√£ t·∫£i xong
    window.addEventListener('load', function() {
      // G·ªçi h√†m backend 'getDashboardData'
      google.script.run
        .withSuccessHandler(onDataLoaded)
        .withFailureHandler(onDataError)
        .getDashboardData(currentMonth);
    });

    function onDataError(error) {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('error-message').textContent = 'L·ªói: ' + error.message;
    }

    function onDataLoaded(dataObject) {
      if (dataObject.error) {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('error-message').textContent = dataObject.error;
        return;
      }
      
      // ·∫®n loader v√† hi·ªÉn th·ªã n·ªôi dung
      document.getElementById('loader').style.display = 'none';
      document.getElementById('main-container').style.display = 'block';

      // C·∫≠p nh·∫≠t c√°c th√†nh ph·∫ßn
      renderSummary(dataObject.summary);
      renderCategoryChart(dataObject.expenseByCategory);
      renderTrendChart(dataObject.incomeVsExpenseTrend);
      renderRecentTransactions(dataObject.recentTransactions);
    }
    
    function renderSummary(summary) {
        document.getElementById('total-income').textContent = summary.totalIncome + ' VNƒê';
        document.getElementById('total-expense').textContent = summary.totalExpense + ' VNƒê';
        document.getElementById('balance').textContent = summary.balance + ' VNƒê';
    }
    
    function renderCategoryChart(chartData) {
        const ctx = document.getElementById('category-chart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Chi ti√™u',
                    data: chartData.data,
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
    }

    function renderTrendChart(trendData) {
        const ctx = document.getElementById('trend-chart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: trendData.labels,
                datasets: [
                    {
                        label: 'Thu nh·∫≠p',
                        data: trendData.incomeData,
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        fill: true,
                        tension: 0.1
                    },
                    {
                        label: 'Chi ti√™u',
                        data: trendData.expenseData,
                        borderColor: '#c0392b',
                        backgroundColor: 'rgba(192, 57, 43, 0.1)',
                        fill: true,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    function renderRecentTransactions(transactions) {
        const tbody = document.getElementById('recent-transactions-body');
        if (transactions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Kh√¥ng c√≥ giao d·ªãch n√†o g·∫ßn ƒë√¢y.</td></tr>';
            return;
        }
        let html = '';
        transactions.forEach(tx => {
            html += `<tr>
                        <td>${tx.date}</td>
                        <td>${tx.description}</td>
                        <td class="${tx.amount.startsWith('+') ? 'income' : 'expense'}">${tx.amount}</td>
                     </tr>`;
        });
        tbody.innerHTML = html;
    }

  </script>
</body>
</html>
